services:
  - type: worker
    name: spothero-facilities-minimal-worker
    env: python
    region: oregon
    plan: free
    autoDeploy: true

    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt

    # Workers do NOT get $PORT by default; provide a fallback.
    # This keeps uvicorn happy so your FastAPI lifespan tasks (refresh_loop + sh_update_loop) run.
    startCommand: >
      uvicorn main:app --host 0.0.0.0 --port ${PORT:-8000} --log-level warning

    envVars:
      - key: GRAPH_TENANT_ID
        sync: false
      - key: GRAPH_CLIENT_ID
        sync: false
      - key: GRAPH_CLIENT_SECRET
        sync: false
      - key: SP_SITE_ID
        sync: false
      - key: SP_DRIVE_ID
        sync: false
      - key: SP_TOKEN_JSON_PATH
        value: Business Optimization/Automation/token/token.json

      - key: TOKEN_REFRESH_HOURS
        value: "12"
      - key: TOKEN_TTL_SECONDS
        value: "900"
      - key: FACILITIES_TTL_SECONDS
        value: "600"
      - key: STARTUP_FORCE_GRAPH_REFRESH
        value: "true"
      - key: FACILITIES_LOG_INFO
        value: "true"

      - key: SH_UPDATE_ENABLED
        value: "true"
      - key: SH_UPDATE_INTERVAL_SECONDS
        value: "14400"
      - key: SH_UPDATE_ONLY_TIERED
        value: "true"
      - key: SH_UPDATE_DRY_RUN
        value: "false"
      - key: SH_UPDATE_DEBUG
        value: "false"
      - key: SH_UPDATE_TZ
        value: "America/Chicago"
      - key: SH_UPDATE_MAX_CONCURRENCY
        value: "2"
      - key: SH_UPDATE_PAUSE_SEC
        value: "0.25"
      - key: SH_UPDATE_JITTER_SEC
        value: "0.15"

      - key: LOG_LEVEL
        value: "INFO"
